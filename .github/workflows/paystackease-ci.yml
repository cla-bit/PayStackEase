name: paystackease-ci

on: [push, pull_request]

jobs:
  ci:
    # Set up operating system
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]  # Optional: test multiple versions

    # Define job steps
    steps:
    - name: Check-out repository
      uses: actions/checkout@v3  # Updated to v3

    - name: Set up Python 3.9
      uses: actions/setup-python@v4  # Updated to v4
      with:
        python-version: ${{ matrix.python-version || '3.9' }}

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential


      ## Alternative Method 2: If you prefer snok/install-poetry, uncomment below and comment above
    - name: Install poetry
      uses: snok/install-poetry@v1
      with:
        version: 2.2.1  # Use specific version instead of 'latest'
        virtualenvs-create: true
        virtualenvs-in-project: true

    - name: Verify Poetry installation
      run: poetry --version

    - name: Configure Poetry
      run: |
        poetry config virtualenvs.create true
        poetry config virtualenvs.in-project true
        poetry config installer.max-workers 10

    - name: Install package
      run: poetry install --no-interaction

    - name: Format code with Black
      run: poetry run black . --check  # Use --check to just verify formatting

    - name: Run PayStackEase with pylint
      run: poetry run pylint paystackease --errors-only --rcfile=.pylintrc || true

    - name: Run test with pylint
      run: poetry run pylint tests --errors-only --rcfile=.pylintrc || true

    - name: Test with pytest (using environment variables)
      env:
        PAYSTACK_SECRET_KEY: ${{ secrets.PAYSTACK_SECRET_KEY }}
      run: poetry run pytest tests/ --cov=paystackease --cov-report=xml

    - name: Use CodeCov to track coverage
      uses: codecov/codecov-action@v4  # Updated to v4
      with:
        files: ./coverage.xml  # coverage report
        fail_ci_if_error: false

    - name: Build documentation
      run: |
        cd docs
        poetry run make html
        cd ..
